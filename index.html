<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Book Engineering (Desain Baru) - WIP Cereal Opak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Fallback background */
            background-image: linear-gradient(to top, #accbee 0%, #e7f0fd 100%);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333;
            color: #fff; text-align: center; border-radius: 8px; padding: 16px;
            position: fixed; z-index: 50; left: 50%; bottom: 30px; opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show { visibility: visible; opacity: 1; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .menu-card {
            transition: all 0.3s ease;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 drop-shadow-sm">Log Book Engineering</h1>
            <p class="text-lg text-gray-600">WIP Cereal Opak (Real-time)</p>
            <div id="auth-status" class="mt-2 text-xs text-gray-500 h-4"></div>
        </header>

        <!-- Menu Pilihan Shift Model Baru -->
        <div class="bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
            <h2 class="text-2xl font-semibold mb-6 text-center text-gray-700">Buat Laporan Baru</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <!-- Shift A -->
                <button data-shift="Shift A" class="add-log-btn menu-card bg-gradient-to-br from-blue-400 to-blue-600 text-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center space-y-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <span class="font-bold text-lg">Shift A</span>
                    <span class="text-xs opacity-80">Samsul Umam</span>
                </button>
                <!-- Shift B -->
                <button data-shift="Shift B" class="add-log-btn menu-card bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center space-y-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <span class="font-bold text-lg">Shift B</span>
                    <span class="text-xs opacity-80">Heriyatman</span>
                </button>
                <!-- Shift C -->
                <button data-shift="Shift C" class="add-log-btn menu-card bg-gradient-to-br from-indigo-500 to-purple-700 text-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center space-y-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a7 7 0 1 0 10 10" /><path d="M12 2A7 7 0 1 0 2 12" /><path d="M12 2v20" /><path d="M22 12H2" /></svg>
                    <span class="font-bold text-lg">Shift C</span>
                    <span class="text-xs opacity-80">Dollis Fredy</span>
                </button>
                <!-- Non Shift -->
                <button data-shift="Non Shift" class="add-log-btn menu-card bg-gradient-to-br from-gray-500 to-gray-700 text-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center space-y-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="font-bold text-lg">Non Shift</span>
                    <span class="text-xs opacity-80">Khairul Iman</span>
                </button>
            </div>
        </div>

        <div class="flex justify-center items-center mb-8">
            <button id="download-excel" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                Unduh Laporan (Excel)
            </button>
        </div>

        <div id="loading-indicator" class="flex justify-center items-center py-10">
            <div class="loader"></div>
            <p class="ml-4 text-gray-500">Menghubungkan ke database...</p>
        </div>

        <div id="log-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
        <div id="no-logs" class="text-center text-gray-500 mt-8 hidden">
            <p class="text-xl">Belum ada catatan. Silakan tambahkan log melalui tombol di atas.</p>
        </div>
    </div>

    <!-- Modal Form -->
    <div id="log-modal" class="fixed inset-0 z-40 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-lg z-50 transform scale-95">
            <form id="log-form" class="p-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 id="modal-title" class="text-2xl font-semibold">Tambah Log Baru</h3>
                    <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <input type="hidden" id="shift" name="shift">
                    <div>
                        <label for="technician" class="block text-sm font-medium text-gray-700 mb-1">Nama Teknisi</label>
                        <input type="text" id="technician" name="technician" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" placeholder="Masukkan nama teknisi">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Pekerjaan</label>
                            <select id="jobType" name="jobType" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg"><option value="Perbaikan">Perbaikan</option><option value="Perawatan">Perawatan</option><option value="Proyek">Proyek</option><option value="Pengecekan">Pengecekan</option><option value="Lainnya">Lainnya</option></select>
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status Pekerjaan</label>
                            <select id="status" name="status" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg"><option value="Selesai">Selesai</option><option value="Sedang Dikerjakan">Sedang Dikerjakan</option><option value="Tertunda">Tertunda</option></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Waktu Mulai</label>
                            <input type="datetime-local" id="startTime" name="startTime" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">Waktu Selesai</label>
                            <input type="datetime-local" id="endTime" name="endTime" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="activity" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kegiatan</label>
                        <textarea id="activity" name="activity" rows="4" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg" placeholder="Jelaskan detail pekerjaan..."></textarea>
                    </div>
                    <div>
                        <label for="photo" class="block text-sm font-medium text-gray-700 mb-1">Unggah Foto (Opsional)</label>
                        <input type="file" id="photo" name="photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
                <div class="text-right pt-4 border-t mt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Simpan Catatan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUserId = null;
        const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/logs`);

        const logContainer = document.getElementById('log-container');
        const noLogsMessage = document.getElementById('no-logs');
        const downloadButton = document.getElementById('download-excel');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('log-modal');
        const logForm = document.getElementById('log-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const authStatus = document.getElementById('auth-status');

        const showToast = (message) => {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };
        const openModal = (shift) => {
            logForm.reset();
            document.getElementById('modal-title').textContent = `Tambah Log Baru - ${shift}`;
            document.getElementById('shift').value = shift;
            modal.classList.remove('hidden');
        };
        const closeModal = () => modal.classList.add('hidden');

        const renderLogs = (logs) => {
            loadingIndicator.classList.add('hidden');
            logContainer.innerHTML = '';
            if (logs.length === 0) {
                noLogsMessage.classList.remove('hidden');
                downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                noLogsMessage.classList.add('hidden');
                downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            logs.forEach(log => {
                const logCard = document.createElement('div');
                logCard.className = 'bg-white rounded-xl shadow-md overflow-hidden flex flex-col';
                const photoHtml = log.photoURL ? `<img src="${log.photoURL}" alt="Foto Kegiatan" class="w-full h-48 object-cover">` : '';
                const canDelete = log.userId === currentUserId;

                logCard.innerHTML = `
                    ${photoHtml}
                    <div class="p-4 flex-grow flex flex-col">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-sm font-semibold px-2.5 py-0.5 rounded ${getShiftColor(log.shift)}">${log.shift}</span>
                                <span class="text-sm font-semibold px-2.5 py-0.5 rounded ${getStatusColor(log.status)}">${log.status}</span>
                            </div>
                            <span class="text-sm font-bold text-gray-700">${log.jobType}</span>
                        </div>
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">${log.technician}</h4>
                        <div class="text-xs text-gray-500 mb-3 space-y-1">
                            <div><strong>Mulai:</strong> ${formatDateTime(log.startTime)}</div>
                            <div><strong>Selesai:</strong> ${formatDateTime(log.endTime)}</div>
                        </div>
                        <p class="text-gray-700 flex-grow mb-4 whitespace-pre-wrap text-sm">${log.activity}</p>
                        <div class="text-right mt-auto">
                            ${canDelete ? `<button data-id="${log.id}" data-photo-path="${log.photoPath || ''}" class="delete-btn text-red-500 hover:text-red-700 text-sm font-medium">Hapus</button>` : ''}
                        </div>
                    </div>
                `;
                logContainer.appendChild(logCard);
            });
        };

        const getShiftColor = (shift) => ({ 'Shift A': 'bg-blue-100 text-blue-800', 'Shift B': 'bg-orange-100 text-orange-800', 'Shift C': 'bg-indigo-100 text-indigo-800', 'Non Shift': 'bg-gray-200 text-gray-800' }[shift] || 'bg-gray-100');
        const getStatusColor = (status) => ({ 'Selesai': 'bg-green-100 text-green-800', 'Sedang Dikerjakan': 'bg-yellow-100 text-yellow-800', 'Tertunda': 'bg-red-100 text-red-800' }[status] || 'bg-gray-100');
        const formatDateTime = (isoString) => isoString ? new Date(isoString).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function main() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authStatus.textContent = `Terhubung sebagai: ${currentUserId.substring(0, 10)}...`;
                    const q = query(logsCollectionRef, orderBy("startTime", "desc"));
                    onSnapshot(q, (snapshot) => {
                        const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderLogs(logs);
                    }, (error) => console.error("Error listening to logs:", error));
                } else {
                    authStatus.textContent = 'Tidak terhubung. Mencoba menghubungkan kembali...';
                }
            });
            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                authStatus.textContent = 'Gagal melakukan autentikasi.';
            }
        }

        document.querySelectorAll('.add-log-btn').forEach(button => button.addEventListener('click', () => openModal(button.dataset.shift)));
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        document.querySelector('.modal-overlay').addEventListener('click', closeModal);
        
        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';
            const formData = new FormData(e.target);
            const photoFile = formData.get('photo');
            const newLog = {
                userId: currentUserId, createdAt: new Date().toISOString(), shift: formData.get('shift'),
                technician: formData.get('technician'), jobType: formData.get('jobType'), status: formData.get('status'),
                startTime: formData.get('startTime'), endTime: formData.get('endTime'), activity: formData.get('activity'),
                photoURL: null, photoPath: null
            };
            if (newLog.endTime < newLog.startTime) {
                alert('Waktu selesai tidak boleh kurang dari waktu mulai.');
                submitButton.disabled = false; submitButton.textContent = 'Simpan Catatan'; return;
            }
            try {
                if (photoFile && photoFile.size > 0) {
                    const photoPath = `images/${appId}/${Date.now()}-${photoFile.name}`;
                    const storageRef = ref(storage, photoPath);
                    const base64String = await fileToBase64(photoFile);
                    await uploadString(storageRef, base64String, 'data_url');
                    newLog.photoURL = await getDownloadURL(storageRef);
                    newLog.photoPath = photoPath;
                }
                await addDoc(logsCollectionRef, newLog);
                showToast('Catatan berhasil disimpan!'); closeModal();
            } catch (error) {
                console.error("Error adding document: ", error); showToast('Gagal menyimpan catatan.');
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'Simpan Catatan';
            }
        });

        logContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                const photoPath = e.target.dataset.photoPath;
                if (confirm('Apakah Anda yakin ingin menghapus catatan ini?')) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/logs`, docId));
                        if (photoPath) await deleteObject(ref(storage, photoPath));
                        showToast('Catatan berhasil dihapus.');
                    } catch (error) {
                        console.error("Error deleting document: ", error); showToast('Gagal menghapus catatan.');
                    }
                }
            }
        });

        downloadButton.addEventListener('click', async () => {
            downloadButton.disabled = true; showToast('Mempersiapkan data unduhan...');
            try {
                const querySnapshot = await getDocs(logsCollectionRef);
                const logs = querySnapshot.docs.map(doc => doc.data());
                if (logs.length === 0) { showToast('Tidak ada data untuk diunduh.'); return; }
                logs.sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
                const dataForExcel = logs.map(log => ({
                    'Shift': log.shift, 'Nama Teknisi': log.technician, 'Jenis Pekerjaan': log.jobType, 'Status': log.status,
                    'Waktu Mulai': formatDateTime(log.startTime), 'Waktu Selesai': formatDateTime(log.endTime),
                    'Deskripsi Kegiatan': log.activity, 'Dibuat Oleh (ID)': log.userId, 'Foto Terlampir': log.photoURL ? 'Ya' : 'Tidak'
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Log Engineering');
                worksheet['!cols'] = [ {wch:15}, {wch:25}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:70}, {wch:30}, {wch:15} ];
                XLSX.writeFile(workbook, 'Laporan_Log_Book_Realtime.xlsx');
            } catch (error) {
                console.error("Error downloading excel: ", error); showToast('Gagal mengunduh laporan.');
            } finally {
                downloadButton.disabled = false;
            }
        });

        main();
    </script>
</body>
</html>

